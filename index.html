<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام فرز الأصوات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        @media (max-width: 640px) {

            .fa-check,
            .fa-times,
            .fa-undo-alt,
            .fa-redo-alt,
            .fa-trash-alt,
            .fa-file-export,
            .fa-save,
            .fa-upload,
            .fa-users,
            .fa-ban {
                margin-right: 2px;
                font-size: 0.9em;
            }
        }

        body {
            font-family: Arial, sans-serif;
        }

        .hidden {
            display: none !important;
        }

        /* تحسين مظهر الأزرار المعطلة */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* منع التحديد المزدوج عند النقر السريع على الأزرار */
        button {
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center p-2 sm:p-4">
    <div id="app"
        class="p-3 sm:p-4 w-full max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg bg-white rounded-lg shadow-lg mt-2 sm:mt-6">
        <h1 class="text-xl sm:text-2xl font-bold text-center mb-2 sm:mb-4">نظام فرز الأصوات الانتخابية</h1>

        <div class="mb-3 sm:mb-4">
            <div class="bg-gray-100 p-2 sm:p-3 rounded-lg shadow mb-2 flex justify-between items-center">
                <span class="text-gray-600 text-sm sm:text-base">الإدخال الحالي:</span>
                <span id="currentBallot" class="text-xl sm:text-2xl font-bold">0</span>
            </div>
            <div class="bg-gray-100 p-2 sm:p-3 rounded-lg shadow flex justify-between items-center">
                <span class="text-gray-600 text-sm sm:text-base">إجمالي الأصوات:</span>
                <span id="totalVotes" class="text-xl sm:text-2xl font-bold">0</span>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-1 sm:gap-2 mb-3 sm:mb-4" id="numericPad"></div>

        <div class="grid grid-cols-1 gap-1 sm:gap-2 mb-3 sm:mb-4">
            <button id="confirmVote"
                class="bg-green-500 hover:bg-green-600 text-white py-2 sm:py-3 text-sm sm:text-base rounded-lg shadow transition duration-200">
                <i class="fas fa-check mr-1"></i> تأكيد
            </button>
        </div>

        <div class="grid grid-cols-2 gap-1 sm:gap-2 mb-3 sm:mb-4">
            <button id="invalidVoteBtn"
                class="bg-gray-500 hover:bg-gray-600 text-white py-2 sm:py-3 text-sm sm:text-base rounded-lg shadow transition duration-200">
                <i class="fas fa-ban mr-1"></i> صوت باطل
            </button>
            <button id="clearEntry"
                class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 sm:py-3 text-sm sm:text-base rounded-lg shadow transition duration-200">
                <i class="fas fa-times mr-1"></i> مسح الإدخال
            </button>
        </div>

        <div class="grid grid-cols-2 gap-1 sm:gap-2 mb-3 sm:mb-4">
            <button id="undoVote"
                class="bg-red-500 hover:bg-red-600 text-white py-2 sm:py-3 text-sm sm:text-base rounded-lg shadow transition duration-200 disabled:opacity-50">
                <i class="fas fa-undo-alt mr-1"></i> تراجع
            </button>
            <button id="redoVote"
                class="bg-blue-400 hover:bg-blue-500 text-white py-2 sm:py-3 text-sm sm:text-base rounded-lg shadow transition duration-200 disabled:opacity-50">
                <i class="fas fa-redo-alt mr-1"></i> إعادة
            </button>
        </div>

        <div class="mb-3 sm:mb-4">
            <div class="bg-gray-100 p-2 sm:p-3 rounded-lg shadow mb-2 flex justify-between items-center">
                <span class="text-gray-600 text-sm sm:text-base">الأصوات الصحيحة:</span>
                <span id="validVotes" class="text-xl sm:text-2xl font-bold">0</span>
            </div>
            <div class="bg-gray-100 p-2 sm:p-3 rounded-lg shadow flex justify-between items-center">
                <span class="text-gray-600 text-sm sm:text-base">الأصوات الباطلة:</span>
                <span id="invalidVotes" class="text-xl sm:text-2xl font-bold">0</span>
            </div>
        </div>

        <div class="bg-gray-100 rounded-lg shadow p-2 sm:p-4 mb-3 sm:mb-4 text-sm sm:text-base max-h-60 overflow-y-auto"
            id="results"></div>

        <!-- زر تحديث عدد المرشحين -->
        <div class="grid grid-cols-1 gap-1 sm:gap-2 mb-2 sm:mb-4">
            <button id="updateCandidateCount"
                class="bg-blue-500 hover:bg-blue-600 text-white py-2 sm:py-3 text-sm sm:text-base rounded-lg shadow transition duration-200">
                <i class="fas fa-users mr-1"></i> تحديث عدد المرشحين
            </button>
        </div>

        <div class="grid grid-cols-2 gap-1 sm:gap-2 mb-2 sm:mb-3">
            <button id="clearAll"
                class="bg-red-600 hover:bg-red-700 text-white py-2 sm:py-3 text-sm sm:text-base rounded-lg shadow transition duration-200">
                <i class="fas fa-trash-alt mr-1"></i> مسح الكل
            </button>
            <button id="openCommitteeModal"
                class="bg-green-600 hover:bg-green-700 text-white py-2 sm:py-3 text-sm sm:text-base rounded-lg shadow transition duration-200">
                <i class="fas fa-file-export mr-1"></i> تصدير النتائج
            </button>
        </div>

        <div class="grid grid-cols-2 gap-1 sm:gap-2 mb-2 sm:mb-3">
            <button id="saveDataLocally"
                class="bg-blue-600 hover:bg-blue-700 text-white py-2 sm:py-3 text-sm sm:text-base rounded-lg shadow transition duration-200">
                <i class="fas fa-save mr-1"></i> حفظ البيانات
            </button>
            <button id="loadDataLocally"
                class="bg-purple-600 hover:bg-purple-700 text-white py-2 sm:py-3 text-sm sm:text-base rounded-lg shadow transition duration-200">
                <i class="fas fa-upload mr-1"></i> استعادة البيانات
            </button>
        </div>
    </div>

    <!-- نافذة مودال -->
    <div id="committeeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">
            <h2 class="text-xl font-bold mb-4 text-center">إدخال بيانات اللجنة الفرعية</h2>

            <label class="block mb-2">عدد الناخبين باللجنة:</label>
            <input type="text" id="totalnumVotes" class="w-full border p-2 rounded mb-3">

            <label class="block mb-2">اللجنة الفرعية رقم:</label>
            <input type="text" id="subCommitteeNumber" class="w-full border p-2 rounded mb-3">

            <label class="block mb-2">مقرها:</label>
            <input type="text" id="subCommitteeLocation" class="w-full border p-2 rounded mb-3">

            <label class="block mb-2">التابعة للجنة العامة رقم:</label>
            <input type="text" id="mainCommitteeNumber" class="w-full border p-2 rounded mb-3">

            <label class="block mb-2">ومقرها:</label>
            <input type="text" id="mainCommitteeLocation" class="w-full border p-2 rounded mb-3">

            <label class="block mb-2">رئيس اللجنة:</label>
            <input type="text" id="committeeHead" class="w-full border p-2 rounded mb-3">

            <div class="flex justify-end mt-4 space-x-reverse space-x-4">
                <button id="exportResults"
                    class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded flex items-center gap-2">
                    <i class="fas fa-file-pdf"></i>
                    تصدير النتائج
                </button>
                <button id="closeCommitteeModal"
                    class="bg-gray-400 hover:bg-gray-500 text-white py-2 px-4 rounded flex items-center gap-2">
                    <i class="fas fa-times-circle"></i>
                    إلغاء
                </button>
            </div>


        </div>
    </div>

    <script>
        // فتح وإغلاق المودال
        document.getElementById('openCommitteeModal').onclick = () => {
            document.getElementById('committeeModal').classList.remove('hidden');
        };
        document.getElementById('closeCommitteeModal').onclick = () => {
            document.getElementById('committeeModal').classList.add('hidden');
        };

    </script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const numericPad = document.getElementById("numericPad");
            const currentBallotEl = document.getElementById("currentBallot");
            const totalVotesEl = document.getElementById("totalVotes");
            const validVotesEl = document.getElementById("validVotes");
            const invalidVotesEl = document.getElementById("invalidVotes");
            const resultsEl = document.getElementById("results");
            const confirmVoteBtn = document.getElementById("confirmVote");
            const clearEntryBtn = document.getElementById("clearEntry");
            const undoVoteBtn = document.getElementById("undoVote");
            const redoVoteBtn = document.getElementById("redoVote");
            const clearAllBtn = document.getElementById("clearAll");
            const exportResultsBtn = document.getElementById("exportResults");
            const saveDataBtn = document.getElementById("saveDataLocally");
            const loadDataBtn = document.getElementById("loadDataLocally");
            const updateCandidateCountBtn = document.getElementById('updateCandidateCount');
            const invalidVoteBtn = document.getElementById("invalidVoteBtn");

            let currentBallot = "";
            let totalVotes = 0;
            let validVotesCount = 0;
            let invalidVotesCount = 0;
            let candidates = 10;
            let votes = {};
            let history = [];
            let historyIndex = -1;

            // منع التحديثات المتعددة السريعة
            let isProcessing = false;

            // Initialize votes
            function initializeVotes(preserveExisting = false) {
                let tempVotes = preserveExisting ? { ...votes } : {};
                votes = {};
                for (let i = 1; i <= candidates; i++) {
                    // إذا كان المرشح موجوداً سابقاً، احتفظ بأصواته
                    votes[i] = preserveExisting && tempVotes[i] !== undefined ? tempVotes[i] : 0;
                }
                renderResults();
            }
            initializeVotes();

            // Update UI
            function renderResults() {
                // ترتيب المرشحين حسب عدد الأصوات (تنازلياً)
                const sortedCandidates = Object.entries(votes).sort((a, b) => b[1] - a[1]);

                resultsEl.innerHTML = sortedCandidates.map(([candidate, count]) => `
                    <div class="flex justify-between items-center border-b pb-1 mb-1">
                        <span class="font-medium text-sm sm:text-base">المرشح ${candidate}</span>
                        <span class="font-bold text-base sm:text-lg">${count}</span>
                    </div>
                `).join("");

                currentBallotEl.textContent = currentBallot || "0";
                totalVotesEl.textContent = totalVotes;
                validVotesEl.textContent = validVotesCount;
                invalidVotesEl.textContent = invalidVotesCount;

                // تحديث حالة أزرار التراجع وإعادة
                undoVoteBtn.disabled = historyIndex < 0;
                redoVoteBtn.disabled = historyIndex >= history.length - 1;
            }

            // بناء لوحة الأرقام
            function buildNumericPad() {
                numericPad.innerHTML = ""; // Clear existing buttons

                const layout = [
                    [9, 8, 7],
                    [6, 5, 4],
                    [3, 2, 1],
                    ['', 0, '']
                ];

                layout.forEach(row => {
                    row.forEach(num => {
                        const btn = document.createElement("button");
                        if (num === '') {
                            btn.className = "invisible"; // لتأمين شكل الشبكة
                        } else {
                            btn.textContent = num;
                            btn.className = "number-display bg-blue-500 hover:bg-blue-600 text-white text-lg sm:text-2xl py-2 sm:py-3 rounded-lg shadow transition duration-200";
                            btn.onclick = () => {
                                currentBallot += num.toString();
                                renderResults();
                            };
                        }
                        numericPad.appendChild(btn);
                    });
                });
            }
            buildNumericPad();

            // تسجيل خطوة في التاريخ
            function pushToHistory() {
                // قطع سجل التاريخ عند هذه النقطة إذا كنا قد تراجعنا سابقًا
                if (historyIndex < history.length - 1) {
                    history = history.slice(0, historyIndex + 1);
                }

                history.push({
                    votes: JSON.parse(JSON.stringify(votes)),
                    totalVotes,
                    validVotesCount,
                    invalidVotesCount
                });
                historyIndex++;
            }

            // Confirm vote
            confirmVoteBtn.addEventListener("click", () => {
                if (isProcessing) return;
                isProcessing = true;

                if (!currentBallot) {
                    alert("يرجى إدخال رقم المرشح أولاً");
                    isProcessing = false;
                    return;
                }

                const candidateNumber = parseInt(currentBallot);
                if (votes.hasOwnProperty(candidateNumber)) {
                    votes[candidateNumber]++;
                    totalVotes++;
                    validVotesCount++;

                    pushToHistory();
                    currentBallot = "";
                    renderResults();
                } else {
                    alert(`المرشح رقم ${candidateNumber} غير موجود`);
                    currentBallot = "";
                    renderResults();
                }

                isProcessing = false;
            });

            // تسجيل صوت باطل
            invalidVoteBtn.addEventListener("click", () => {
                if (isProcessing) return;
                isProcessing = true;

                invalidVotesCount++;
                totalVotes++;

                pushToHistory();
                currentBallot = "";
                renderResults();

                isProcessing = false;
            });

            // Clear entry
            clearEntryBtn.addEventListener("click", () => {
                currentBallot = "";
                renderResults();
            });

            // Undo vote
            undoVoteBtn.addEventListener("click", () => {
                if (isProcessing || historyIndex < 0) return;
                isProcessing = true;

                historyIndex--;

                if (historyIndex < 0) {
                    // إعادة تهيئة إذا لم يكن هناك تاريخ
                    votes = {};
                    initializeVotes(false);
                    totalVotes = 0;
                    validVotesCount = 0;
                    invalidVotesCount = 0;
                } else {
                    const prevState = history[historyIndex];
                    votes = JSON.parse(JSON.stringify(prevState.votes));
                    totalVotes = prevState.totalVotes;
                    validVotesCount = prevState.validVotesCount;
                    invalidVotesCount = prevState.invalidVotesCount;
                }

                renderResults();
                isProcessing = false;
            });

            // Redo vote
            redoVoteBtn.addEventListener("click", () => {
                if (isProcessing || historyIndex >= history.length - 1) return;
                isProcessing = true;

                historyIndex++;
                const nextState = history[historyIndex];
                votes = JSON.parse(JSON.stringify(nextState.votes));
                totalVotes = nextState.totalVotes;
                validVotesCount = nextState.validVotesCount;
                invalidVotesCount = nextState.invalidVotesCount;

                renderResults();
                isProcessing = false;
            });

            // Clear all
            clearAllBtn.addEventListener("click", () => {
                if (isProcessing) return;
                isProcessing = true;

                if (confirm("هل أنت متأكد من رغبتك في مسح جميع البيانات؟")) {
                    votes = {};
                    initializeVotes(false); // إعادة تهيئة بدون الاحتفاظ بالبيانات
                    totalVotes = 0;
                    validVotesCount = 0;
                    invalidVotesCount = 0;
                    history = [];
                    historyIndex = -1;
                    currentBallot = "";
                    renderResults();
                }

                isProcessing = false;
            });

            // زر تصدير النتائج
            exportResultsBtn.addEventListener("click", async () => {
                if (isProcessing) return;

                isProcessing = true;
                exportResultsBtn.disabled = true;
                exportResultsBtn.textContent = "جاري التصدير...";

                const now = new Date();
                const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                const timeStr = `${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}`;

                // ترتيب المرشحين حسب عدد الأصوات تنازليًا
                const sortedCandidates = Object.entries(votes).sort((a, b) => b[1] - a[1]);

                try {
                    await createPdfWithHtml2Pdf(sortedCandidates, dateStr, timeStr);
                } catch (error) {
                    console.error("خطأ في إنشاء PDF:", error);
                    alert("حدث خطأ أثناء إنشاء ملف PDF. يرجى المحاولة مرة أخرى.");
                } finally {
                    isProcessing = false;
                    exportResultsBtn.disabled = false;
                    exportResultsBtn.innerHTML = 'تصدير النتائج <i class="fas fa-file-pdf"></i>';
                }
            });

            // إنشاء PDF باستخدام html2pdf - نسخة محسنة
            function createPdfWithHtml2Pdf(sortedCandidates, dateStr, timeStr) {
                return new Promise(async (resolve, reject) => {
                    const element = document.createElement('div');
                    element.style.width = '100%';
                    element.style.fontFamily = "'Cairo', 'Arial', sans-serif'";

                    // عدد العناصر في الصفحة الأولى
                    const firstPageCount = 20;
                    const nextPagesCount = 30;

                    let pagesHtml = '';

                    const createTableHeader = () => `
                        <thead>
                            <tr style="background-color: #16a085; color: white;">
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: right; width: 70%;">المرشح</th>
                                <th style="border: 1px solid #ddd; padding: 6px; text-align: center; width: 30%;">عدد الأصوات</th>
                            </tr>
                        </thead>
                    `;

                    // الصفحة الأولى (20 اسم فقط)
                    let firstPageRows = '';
                    sortedCandidates.slice(0, firstPageCount).forEach(([candidate, count], index) => {
                        const rowStyle = index % 2 === 0 ? 'background-color: #f9f9f9;' : 'background-color: #ffffff;';
                        firstPageRows += `
                            <tr style="${rowStyle}">
                                <td style="border: 1px solid #ddd; padding: 5px; text-align: right;"> رقم ${candidate}</td>
                                <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${count}</td>
                            </tr>
                        `;
                    });

                    // حساب إجمالي الأصوات من المرشحين
                    const totalCandidateVotes = sortedCandidates.reduce((sum, [_, count]) => sum + count, 0);
                    const subCommitteeNumber = document.getElementById('subCommitteeNumber').value;
                    const subCommitteeLocation = document.getElementById('subCommitteeLocation').value;
                    const mainCommitteeNumber = document.getElementById('mainCommitteeNumber').value;
                    const mainCommitteeLocation = document.getElementById('mainCommitteeLocation').value;
                    const committeeHead = document.getElementById('committeeHead').value;
                    const totalnumVotes = document.getElementById('totalnumVotes').value;

                    pagesHtml += `
                        <div>
                            <div style="text-align: right; padding: 10px; word-spacing: 3px;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <h1 style="color: #16a085; margin: 0; font-size: 24px;">نتائج &nbsp;&nbsp;الانتخابات</h1>
                                    <p style="margin: 5px 0 0 0; font-size: 14px;">تاريخ التقرير &nbsp;&nbsp; ${dateStr}</p>
                                </div>
                                
                                <div style="border: 1px solid #16a085; border-radius: 5px; padding: 10px; margin-bottom: 15px; background-color: #f5f5f5;">
                                    <h3 style="color: #e74c3c; margin: 0 0 10px 0; font-size: 18px; text-align: center;">
                                        ملخص نتائج اللجنة الفرعية رقم &nbsp;( ${subCommitteeNumber} )
                                    </h3>

                                    <div style="display: flex; justify-content: space-between; font-size: 14px; direction: rtl;">
                                        <div style="flex: 1; text-align: right;"><strong>ومقرها</strong>: ${subCommitteeLocation}</div>
                                        <div style="flex: 1; text-align: center;"><strong>التابعة للجنة العامة رقم </strong>: ${mainCommitteeNumber}</div>
                                        <div style="flex: 1; text-align: left;"><strong>ومقر اللجنة العامة </strong>: ${mainCommitteeLocation}</div>
                                    </div>


                                    <table style="width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; ">
                                        <tr>
                                            <td style="padding: 3px 0;"><strong>إجمالي عدد الناخبين المقيدين &nbsp;باللجنة</strong>:</td>
                                            <td style="text-align: left; padding: 3px 0;">${totalnumVotes}<strong>&nbsp;&nbsp;&nbsp;ناخبًا </strong></td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 3px 0;"><strong>إجمالي عدد الأصوات المُدلى &nbsp;بها</strong>:</td>
                                            <td style="text-align: left; padding: 3px 0;">${totalVotes}<strong>&nbsp;&nbsp;&nbsp;صوتًا </strong></td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 3px 0;"><strong>إجمالي عدد الأصوات &nbsp;الباطلـــــة</strong>:</td>
                                            <td style="text-align: left; padding: 3px 0;">${invalidVotesCount}<strong>&nbsp;&nbsp;&nbsp;صوتًا </strong></td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 3px 0;"><strong>إجمالي عدد الأصوات &nbsp;الصحيحة</strong>:</td>
                                            <td style="text-align: left; padding: 3px 0;">${validVotesCount}<strong>&nbsp;&nbsp;&nbsp;صوتًا </strong></td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 3px 0;"><strong>عدد المرشحين المقيدين &nbsp;باللجنة</strong>:</td>
                                            <td style="text-align: left; padding: 3px 0;">${sortedCandidates.length}<strong>&nbsp;&nbsp;&nbsp;مرشحًا </strong></td>
                                        </tr>
                                    </table>
                                    <p style="color: #e74c3c; text-align: center;"><strong> رئيس اللجنة المستشار </strong>: ${committeeHead}</p>
                                </div>
                                
                                <h3 style="color: #16a085; margin: 10px 0; font-size: 16px;">ترتيب المرشحين حسب عدد الأصوات</h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                    ${createTableHeader()}
                                    <tbody>
                                        ${firstPageRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;

                    // الصفحات التالية (كل صفحة تحتوي 25 اسم)
                    for (let i = firstPageCount; i < sortedCandidates.length; i += nextPagesCount) {
                        const chunk = sortedCandidates.slice(i, i + nextPagesCount);
                        let rows = '';
                        chunk.forEach(([candidate, count], index) => {
                            const rowStyle = index % 2 === 0 ? 'background-color: #f9f9f9;' : 'background-color: #ffffff;';
                            rows += `
                                <tr style="${rowStyle}">
                                    <td style="border: 1px solid #ddd; padding: 5px; text-align: right;"> رقم ${candidate}</td>
                                    <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${count}</td>
                                </tr>
                            `;
                        });

                        const currentPage = Math.ceil((i - firstPageCount) / nextPagesCount) + 2;
                        const totalPages = Math.ceil((sortedCandidates.length - firstPageCount) / nextPagesCount) + 1;
                        const isLastPage = i + nextPagesCount >= sortedCandidates.length;

                        pagesHtml += `
                            <div>
                                <div dir="rtl" style="text-align: right; padding: 10px;">
                                    <div style="text-align: center; margin-bottom: 10px;">
                                        <h2 style="color: #16a085; margin: 0; font-size: 18px;">نتائج الانتخابات - تابع</h2>
                                        <p style="margin: 5px 0 0 0; font-size: 12px;">تاريخ التقرير  &nbsp;&nbsp;${dateStr}</p>
                                    </div>
                                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                        ${createTableHeader()}
                                        <tbody>
                                            ${rows}
                                        </tbody>
                                    </table>
                                    <div style="text-align: left; font-size: 10px; color: #777; margin-top: 10px;">
                                        صفحة ${currentPage} من ${totalPages}
                                    </div>

                                    ${isLastPage ? `
                                    <div style="text-align: center; font-size: 10px; color: #444;">
                                        إهداء من المستشار <strong>محمد الحمراوي</strong> للسادة الأعضاء
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }

                    element.innerHTML = pagesHtml;

                    document.body.appendChild(element);
                    await new Promise(requestAnimationFrame);

                    const opt = {
                        margin: [5, 10, 10, 10],  // [top, right, bottom, left] في مم
                        filename: `نتائج_الانتخابات_${dateStr}_${timeStr}.pdf`,
                        image: { type: 'jpeg', quality: 0.95 },
                        html2canvas: {
                            scale: 2,
                            useCORS: true,
                            logging: false,
                            letterRendering: true
                        },
                        jsPDF: {
                            unit: 'mm',
                            format: 'a4',
                            orientation: 'portrait',
                            compress: true
                        },
                        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] },
                        // تحميل خط القاهرة لدعم اللغة العربية
                        fontFaces: [
                            {
                                family: 'Cairo',
                                style: 'normal',
                                weight: 'normal',
                                src: [{ url: 'https://fonts.gstatic.com/s/cairo/v20/SLXVc1nY6HkvangtZmpQdkhzfH5lkSs2SgRjCAGMQ1z0hGA-W1Q.woff2', format: 'woff2' }]
                            }
                        ]
                    };

                    html2pdf().from(element).set(opt).save()
                        .then(() => {
                            document.body.removeChild(element);
                            resolve();
                        })
                        .catch(err => {
                            document.body.removeChild(element);
                            reject(err);
                        });
                });

            }

            // // Excel
            // exportResultsBtn.addEventListener("click", () => {
            //     if (isProcessing) return;
            //     isProcessing = true;

            //     const now = new Date();
            //     const dateStr = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
            //     const timeStr = `${now.getHours().toString().padStart(2, '0')}-${now.getMinutes().toString().padStart(2, '0')}`;

            //     // ترتيب البيانات تنازلياً حسب عدد الأصوات
            //     const sortedCandidates = Object.entries(votes).sort((a, b) => b[1] - a[1]);

            //     // إنشاء بيانات الجدول
            //     const data = [["المرشح", "عدد الأصوات"]];
            //     sortedCandidates.forEach(([candidate, count]) => {
            //         data.push([candidate, count]);
            //     });

            //     // إضافة ملخص إجمالي
            //     data.push([]);
            //     data.push(["إجمالي الأصوات", totalVotes]);
            //     data.push(["الأصوات الصحيحة", validVotesCount]);
            //     data.push(["الأصوات الباطلة", invalidVotesCount]);

            //     // إنشاء ورقة عمل وملف Excel
            //     const worksheet = XLSX.utils.aoa_to_sheet(data);
            //     const workbook = XLSX.utils.book_new();
            //     XLSX.utils.book_append_sheet(workbook, worksheet, "نتائج");

            //     // حفظ الملف
            //     XLSX.writeFile(workbook, `نتائج_الانتخابات_${dateStr}_${timeStr}.xlsx`);

            //     isProcessing = false;
            // });

            // Save data locally
            saveDataBtn.addEventListener("click", () => {
                if (isProcessing) return;
                isProcessing = true;

                try {
                    const dataToSave = {
                        votes: votes,
                        totalVotes: totalVotes,
                        validVotesCount: validVotesCount,
                        invalidVotesCount: invalidVotesCount,
                        history: history,
                        historyIndex: historyIndex,
                        candidates: candidates,
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem("voteCounterData", JSON.stringify(dataToSave));
                    alert("تم حفظ البيانات بنجاح");
                } catch (error) {
                    alert("حدث خطأ أثناء حفظ البيانات: " + error.message);
                }

                isProcessing = false;
            });

            // Load data locally
            loadDataBtn.addEventListener("click", () => {
                if (isProcessing) return;
                isProcessing = true;

                try {
                    const data = localStorage.getItem("voteCounterData");
                    if (data) {
                        const parsed = JSON.parse(data);
                        votes = parsed.votes || {};
                        totalVotes = parsed.totalVotes || 0;
                        validVotesCount = parsed.validVotesCount || 0;
                        invalidVotesCount = parsed.invalidVotesCount || 0;
                        history = parsed.history || [];
                        historyIndex = parsed.historyIndex || -1;

                        // استعادة عدد المرشحين إن وجد
                        if (parsed.candidates) {
                            candidates = parsed.candidates;
                        }

                        renderResults();

                        // عرض وقت آخر حفظ
                        if (parsed.timestamp) {
                            const saveDate = new Date(parsed.timestamp);
                            const formattedDate = saveDate.toLocaleString('ar-EG');
                            alert(`تم استعادة البيانات بنجاح\nآخر حفظ: ${formattedDate}`);
                        } else {
                            alert("تم استعادة البيانات بنجاح");
                        }
                    } else {
                        alert("لا توجد بيانات محفوظة");
                    }
                } catch (error) {
                    alert("حدث خطأ أثناء استعادة البيانات: " + error.message);
                }

                isProcessing = false;
            });

            // تحديث عدد المرشحين
            updateCandidateCountBtn.addEventListener('click', () => {
                if (isProcessing) return;
                isProcessing = true;

                // إنشاء مربع حوار مخصص
                const dialogTitle = document.createElement('div');
                dialogTitle.innerHTML = `
                    <div style="position: fixed; z-index: 1000; top: 0; left: 0; right: 0; bottom: 0; 
                          background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;">
                        <div style="background: white; border-radius: 8px; padding: 20px; width: 85%; max-width: 300px;">
                            <h3 style="margin-top: 0; font-weight: bold; font-size: 16px; text-align: center; margin-bottom: 15px;">
                                تحديث عدد المرشحين
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <input type="number" id="candidateInput" style="padding: 8px; border: 1px solid #ccc; 
                                      border-radius: 4px; text-align: center; font-size: 16px;" placeholder="أدخل عدد المرشحين" value="${candidates}">
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    <button id="confirmCandidates" style="flex: 1; background: #3b82f6; color: white; 
                                          border: none; padding: 8px; border-radius: 4px; font-weight: bold;">تأكيد</button>
                                    <button id="cancelCandidates" style="flex: 1; background: #ef4444; color: white; 
                                          border: none; padding: 8px; border-radius: 4px; font-weight: bold;">إلغاء</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(dialogTitle);

                // التركيز على حقل الإدخال وتحديد المحتوى
                setTimeout(() => {
                    const input = document.getElementById('candidateInput');
                    input.focus();
                    input.select();
                }, 100);

                // إعداد الأزرار
                document.getElementById('confirmCandidates').addEventListener('click', () => {
                    const inputValue = document.getElementById('candidateInput').value;
                    document.body.removeChild(dialogTitle);

                    const count = parseInt(inputValue);
                    if (!isNaN(count) && count > 0) {
                        candidates = count;

                        // الاحتفاظ بالبيانات الموجودة أثناء إعادة تهيئة القائمة
                        initializeVotes(true);

                        // إعادة حساب إجمالي الأصوات
                        validVotesCount = 0;
                        Object.values(votes).forEach(voteCount => {
                            validVotesCount += voteCount;
                        });
                        totalVotes = validVotesCount + invalidVotesCount;

                        // تحديث سجل التاريخ
                        if (history.length > 0 && historyIndex >= 0) {
                            history[historyIndex] = {
                                votes: JSON.parse(JSON.stringify(votes)),
                                totalVotes,
                                validVotesCount,
                                invalidVotesCount
                            };
                        }

                        alert('تم تحديث عدد المرشحين بنجاح.');
                    } else {
                        alert('يرجى إدخال رقم صحيح أكبر من 0.');
                    }

                    isProcessing = false;
                });

                document.getElementById('cancelCandidates').addEventListener('click', () => {
                    document.body.removeChild(dialogTitle);
                    isProcessing = false;
                });

                // إغلاق مربع الحوار عند النقر خارجه
                dialogTitle.addEventListener('click', (e) => {
                    if (e.target === dialogTitle) {
                        document.body.removeChild(dialogTitle);
                        isProcessing = false;
                    }
                });
            });

            // إضافة الاستماع لأحداث لوحة المفاتيح
            document.addEventListener('keydown', (e) => {
                // أرقام من لوحة المفاتيح
                if (e.key >= '0' && e.key <= '9') {
                    currentBallot += e.key;
                    renderResults();
                }
                // زر الإدخال للتأكيد
                else if (e.key === 'Enter') {
                    confirmVoteBtn.click();
                }
                // زر الحذف لمسح الإدخال
                else if (e.key === 'Backspace' || e.key === 'Delete') {
                    currentBallot = currentBallot.slice(0, -1);
                    renderResults();
                }
                // زر المسافة للصوت الباطل
                else if (e.key === ' ') {
                    invalidVoteBtn.click();
                }
                // الأسهم للتنقل في التاريخ
                else if (e.key === 'ArrowLeft' && !undoVoteBtn.disabled) {
                    undoVoteBtn.click();
                }
                else if (e.key === 'ArrowRight' && !redoVoteBtn.disabled) {
                    redoVoteBtn.click();
                }
            });

            // تخزين تلقائي كل 5 دقائق
            setInterval(() => {
                if (!isProcessing && totalVotes > 0) {
                    try {
                        const dataToSave = {
                            votes: votes,
                            totalVotes: totalVotes,
                            validVotesCount: validVotesCount,
                            invalidVotesCount: invalidVotesCount,
                            history: history,
                            historyIndex: historyIndex,
                            candidates: candidates,
                            timestamp: new Date().toISOString()
                        };
                        localStorage.setItem("voteCounterData_auto", JSON.stringify(dataToSave));
                        console.log("تم الحفظ التلقائي: " + new Date().toLocaleTimeString());
                    } catch (error) {
                        console.error("خطأ في الحفظ التلقائي: ", error);
                    }
                }
            }, 300000); // كل 5 دقائق

            // محاولة استعادة البيانات المخزنة تلقائياً عند التحميل
            try {
                const data = localStorage.getItem("voteCounterData");
                if (data) {
                    const parsed = JSON.parse(data);
                    votes = parsed.votes || {};
                    totalVotes = parsed.totalVotes || 0;
                    validVotesCount = parsed.validVotesCount || 0;
                    invalidVotesCount = parsed.invalidVotesCount || 0;
                    history = parsed.history || [];
                    historyIndex = parsed.historyIndex || -1;

                    if (parsed.candidates) {
                        candidates = parsed.candidates;
                    }

                    renderResults();
                }
            } catch (error) {
                console.error("خطأ في استعادة البيانات عند التحميل: ", error);
            }

            // إضافة خاصية منع إغلاق الصفحة بالخطأ
            // إضافة خاصية منع إغلاق الصفحة بالخطأ
            window.addEventListener('beforeunload', function (e) {
                // إذا كان هناك أصوات مدخلة ولم يتم حفظها صراحة
                if (totalVotes > 0 && !isProcessing) {
                    e.preventDefault(); // لمنع السلوك الافتراضي
                    e.returnValue = ''; // عرض رسالة تأكيد
                }
            });


        });
    </script>
</body>

</html>